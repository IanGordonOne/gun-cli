{"id":"Lv1m","dependencies":[{"name":"C:\\Users\\shadow\\projects\\open-source\\gun-cli\\tsconfig.json","includedInParent":true,"mtime":1603470512092},{"name":"C:\\Users\\shadow\\projects\\open-source\\gun-cli\\package.json","includedInParent":true,"mtime":1607332937128}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.registerGunFS=c,exports.getGunFSHash=u,exports.headers_ResponseToObj=l,exports.headers_ObjToResponse=f,exports.downloadFile=void 0;var e=function(){return(e=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)},n=function(e,n,t,r){return new(t||(t=Promise))(function(o,s){function a(e){try{c(r.next(e))}catch(n){s(n)}}function i(e){try{c(r.throw(e))}catch(n){s(n)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(a,i)}c((r=r.apply(e,n||[])).next())})},t=function(e,n){var t,r,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},\"function\"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(t)throw new TypeError(\"Generator is already executing.\");for(;a;)try{if(t=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=n.call(e,a)}catch(i){s=[6,i],r=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}},r=\"GFS\",o=\"SHA-256\",s=new RegExp(\"^\"+r+\"/\"+o+\"/([A-Fa-f0-9]+)$\"),a=65535,i=\"<EOF>\";function c(c){return n(this,void 0,void 0,function(){return t(this,function(h){return c.on(\"opt\",function(h){return n(this,void 0,void 0,function(){var d,p,g;return t(this,function(b){switch(b.label){case 0:return console.log(\"registering gunfs\",h.opt.mesh),this.to.next(h),h.once?[2]:[4,window.caches.open(r)];case 1:return d=b.sent(),p={},g={},c.obtain=function(o){return n(this,void 0,void 0,function(){var a,i,c,u,f=this;return t(this,function(g){switch(g.label){case 0:return console.log(\"[\"+r+\"] obtain\",o,h.opt.mesh),o&&o.match(s)?[4,d.match(o)]:[2,Promise.reject(\"malformed fsid\")];case 1:return(a=g.sent())?(i=l(a),[4,a.blob()]):[3,3];case 2:return c=g.sent(),u=window.URL.createObjectURL(c),[2,e(e({},i),{url:u})];case 3:console.log(\"[\"+r+\"] could not find \"+o+\" in local cache\"),g.label=4;case 4:return[2,new Promise(function(e){p[o]=function(s){return n(f,void 0,void 0,function(){var n;return t(this,function(t){return console.warn(\"[\"+r+'] found and delivered gfs file \"'+o+'\"'),n=window.URL.createObjectURL(s),[2,e({url:n})]})})},h.opt.mesh.say({dam:\"gfs\",find:o})})]}})})},c.files=function(r){return n(this,void 0,void 0,function(){var o,s,a=this;return t(this,function(i){switch(i.label){case 0:return[4,d.keys()];case 1:return o=i.sent(),s=o.filter(function(e){return!r||r(e)}).map(function(r){return n(a,void 0,void 0,function(){var n,o,s,a;return t(this,function(t){switch(t.label){case 0:return[4,d.match(r)];case 1:return(n=t.sent())&&\"function\"==typeof n.blob?(o=l(n),[4,n.blob()]):[2];case 2:return s=t.sent(),a=window.URL.createObjectURL(s),[2,e(e({},o),{url:a})]}})})}),[2,Promise.all(s)]}})})},c.store=function(e){return n(this,void 0,void 0,function(){var n,s,a,i,c,l,h;return t(this,function(t){switch(t.label){case 0:return e?(console.log(\"[\"+r+\"] generating \"+o+\"-hash ...\"),[4,u(e)]):[2,console.error(\"[\"+r+\"] no file provided\")];case 1:return n=t.sent(),s=r+\"/\"+o+\"/\"+n,a=e.name,i=e.size,c=e.type,l=Date.now(),h=f({name:a,hash:n,fsid:s,type:c,size:i,created:l}),console.log(\"[\"+r+\"] store file to cache \"+s,{name:a,size:i,type:c}),[4,d.put(s,new Response(e,{headers:h}))];case 2:return t.sent(),[2,{name:a,size:i,type:c,hash:n,fsid:s,algorithm:o,created:l}]}})})},h.opt.mesh.hear.gfs=function(e,o){return n(this,void 0,void 0,function(){var c,u,f,b,v,w,y,m,S=this;return t(this,function(F){switch(F.label){case 0:return c=e.find,u=e.found,f=e.pick,(v=(b=c||u||f)&&b.match(s))?(w=v[1].substr(0,8),c?[4,d.match(c)]:[3,2]):[2,console.error(\"[\"+r+\"] invalid gfs message\",e)];case 1:return F.sent()?(console.warn(\"[\"+r+'] offering \"'+w+'\"',o),h.opt.mesh.say({dam:\"gfs\",found:c}),[3,5]):[2,console.debug(\"[\"+r+\"] !cacheMatch for \"+w)];case 2:return u&&p[u]?(console.warn(\"[\"+r+\"] a peer offered a file we're looking for\",o),o.ondatachannel?g[u]?[2,console.warn(\"[\"+r+\"] thanks but no thanks, \"+o.id,o)]:(g[u]=o,h.opt.mesh.say({dam:\"gfs\",pick:u},o),o.ondatachannel.gfs=o.ondatachannel.gfs||function(e){console.warn(\"[\"+r+\"] ondatachannel, \"+o.id,e);var s,a=e.channel,c=[];a.binaryType=\"arraybuffer\",a.onopen=function(e){console.log(\"[\"+w+\":finding].onopen\",e)},a.onmessage=function(e){return n(this,void 0,void 0,function(){var n,r,o,l;return t(this,function(t){console.log(\"[\"+w+\":finding].onmessage\",e.data),n=e.data;try{\"{\"===n[0]?(s=JSON.parse(n),console.log(\"headers\",s)):n!==i?(console.log(\"[\"+w+\":finding].onmessage\",c.length),c.push(n)):(r=c.reduce(function(e,n){var t=new Uint8Array(e.byteLength+n.byteLength);return t.set(new Uint8Array(e),0),t.set(new Uint8Array(n),e.byteLength),t},new Uint8Array),o=new Blob([r]),l=new Response(o,{headers:s}),d.put(b,l),a.close(),p[u](o),delete p[u],delete g[u])}catch(f){console.log(\"File transfer failed\")}return[2]})})},a.onclose=function(){console.log(\"[\"+w+\":finding].onclose\")}},[3,5]):[2,console.warn(\"[\"+r+\"] missing peer.ondatachannel\",o)]):[3,3];case 3:return f?(console.log(\"[\"+w+\":pick] we got picked to deliver a file\"),[4,d.match(f)]):[3,5];case 4:if(!(y=F.sent()))return[2,console.warn(\"[\"+r+\"] !cacheResponse for \"+w)];(m=o.createDataChannel(\"gfs\")).binaryType=\"arraybuffer\",m.onopen=function(){return n(S,void 0,void 0,function(){var e,n,r,o;return t(this,function(t){switch(t.label){case 0:return y.headers,e=l(y),m.send(JSON.stringify(e)),[4,y.blob()];case 1:return[4,t.sent().arrayBuffer()];case 2:for(n=t.sent(),r=n.byteLength,o=0;o<r;o+=a)console.log(\"[\"+w+\":pick] delivering the file [\"+o+\"/\"+r+\"]\"),m.send(n.slice(o,o+a));return m.send(i),[2]}})})},F.label=5;case 5:return[2]}})})},[2]}})})}),[2]})})}function u(e){return n(this,void 0,void 0,function(){var n,r,s,a,i;return t(this,function(t){switch(t.label){case 0:return[4,new Response(e).arrayBuffer()];case 1:return n=t.sent(),[4,crypto.subtle.digest(o,n)];case 2:for(r=t.sent(),console.log(\"hash\",r),s=\"\",a=new DataView(r),i=0;i<r.byteLength;i+=4)s+=a.getUint32(i).toString(16).padStart(2,\"0\");return[2,s]}})})}function l(e){return{name:e.headers.get(\"X-GFS-NAME\"),hash:e.headers.get(\"X-GFS-HASH\"),fsid:e.headers.get(\"X-GFS-FSID\"),type:e.headers.get(\"X-GFS-TYPE\"),size:parseInt(e.headers.get(\"X-GFS-SIZE\")||\"0\"),created:parseInt(e.headers.get(\"X-GFS-CREATED\")||\"0\")}}function f(e){return{\"X-GFS-NAME\":e.name,\"X-GFS-HASH\":e.hash,\"X-GFS-FSID\":e.fsid,\"X-GFS-TYPE\":e.type,\"X-GFS-SIZE\":e.size.toString(),\"X-GFS-CREATED\":e.created.toString(),\"X-GFS-ALGORITHM\":o,\"Content-Type\":e.type,\"Content-Length\":e.size.toString()}}var h=function(e,n){var t=document.createElement(\"a\"),r=window.URL.createObjectURL(e);t.href=r,t.download=n,t.click(),window.URL.revokeObjectURL(r),t.remove()};exports.downloadFile=h;"},"sourceMaps":null,"error":null,"hash":"950ffb913ecd984df4b51182586626ae","cacheData":{"env":{}}}